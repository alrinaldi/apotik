<!DOCTYPE html>
<html>
<?php 
    $query=$this->db->query("SELECT id FROM obat ");
    $jum_obat=$query->num_rows();
        $td = date('Y-m-d');
        $lw = date('Y-m-d', strtotime("-2 week"));
        echo $lw;
?>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Lumino - Dashboard</title>
    <link href="<?php echo base_url().'desain/lumino/css/bootstrap.min.css' ?>" rel="stylesheet">
    <link href="<?php echo base_url().'desain/lumino/css/font-awesome.min.css'?>" rel="stylesheet">
    <link href="<?php echo base_url().'desain/lumino/css/datepicker3.css'?>" rel="stylesheet">
    <link href="<?php echo base_url().'desain/lumino/css/styles.css'?>" rel="stylesheet">
     <link rel="stylesheet" href="<?php echo base_url().'assets/plugins/datatables/dataTables.bootstrap.css'?>">
    <!--Custom Font-->
    <link href="https://fonts.googleapis.com/css?family=Montserrat:300,300i,400,400i,500,500i,600,600i,700,700i" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="<?php echo base_url().'assets/plugins/toast/jquery.toast.min.css'?>"/>
    <!--[if lt IE 9]>
    <script src="js/html5shiv.js"></script>
    <script src="js/respond.min.js"></script>
    <![endif]-->

    

</head>
<body>
    <nav class="navbar navbar-custom navbar-fixed-top" role="navigation">
        <div class="container-fluid">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#sidebar-collapse"><span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span></button>
                <a class="navbar-brand" href="#"><span>Lumino</span>Admin</a>
                <ul class="nav navbar-top-links navbar-right">
                    <li class="dropdown"><a class="dropdown-toggle count-info" data-toggle="dropdown" href="#">
                        <em class="fa fa-envelope"></em><span class="label label-danger">15</span>
                    </a>
                        <ul class="dropdown-menu dropdown-messages">
                            <li>
                                <div class="dropdown-messages-box"><a href="profile.html" class="pull-left">
                                    <img alt="image" class="img-circle" src="http://placehold.it/40/30a5ff/fff">
                                    </a>
                                    <div class="message-body"><small class="pull-right">3 mins ago</small>
                                        <a href="#"><strong>John Doe</strong> commented on <strong>your photo</strong>.</a>
                                    <br /><small class="text-muted">1:24 pm - 25/03/2015</small></div>
                                </div>
                            </li>
                            <li class="divider"></li>
                            <li>
                                <div class="dropdown-messages-box"><a href="profile.html" class="pull-left">
                                    <img alt="image" class="img-circle" src="http://placehold.it/40/30a5ff/fff">
                                    </a>
                                    <div class="message-body"><small class="pull-right">1 hour ago</small>
                                        <a href="#">New message from <strong>Jane Doe</strong>.</a>
                                    <br /><small class="text-muted">12:27 pm - 25/03/2015</small></div>
                                </div>
                            </li>
                            <li class="divider"></li>
                            <li>
                                <div class="all-button"><a href="#">
                                    <em class="fa fa-inbox"></em> <strong>All Messages</strong>
                                </a></div>
                            </li>
                        </ul>
                    </li>
                    <li class="dropdown"><a class="dropdown-toggle count-info" data-toggle="dropdown" href="#">
                        <em class="fa fa-bell"></em><span class="label label-info">5</span>
                    </a>
                        <ul class="dropdown-menu dropdown-alerts">
                            <li><a href="#">
                                <div><em class="fa fa-envelope"></em> 1 New Message
                                    <span class="pull-right text-muted small">3 mins ago</span></div>
                            </a></li>
                            <li class="divider"></li>
                            <li><a href="#">
                                <div><em class="fa fa-heart"></em> 12 New Likes
                                    <span class="pull-right text-muted small">4 mins ago</span></div>
                            </a></li>
                            <li class="divider"></li>
                            <li><a href="#">
                                <div><em class="fa fa-user"></em> 5 New Followers
                                    <span class="pull-right text-muted small">4 mins ago</span></div>
                            </a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div><!-- /.container-fluid -->
    </nav>
    <div id="sidebar-collapse" class="col-sm-3 col-lg-2 sidebar">
        <div class="profile-sidebar">
            <div class="profile-userpic">
                <img src="http://placehold.it/50/30a5ff/fff" class="img-responsive" alt="">
            </div>
            <div class="profile-usertitle">
                <div class="profile-usertitle-name">Username</div>
                <div class="profile-usertitle-status"><span class="indicator label-success"></span>Online</div>
            </div>
            <div class="clear"></div>
        </div>
        <div class="divider"></div>
        <form role="search">
            <div class="form-group">
                <input type="text" class="form-control" placeholder="Search">
            </div>
        </form>
         <ul class="nav menu">
            <li class="active"><a href="index.html"><em class="fa fa-dashboard">&nbsp;</em> Dashboard</a></li>
            <li class="parent "><a data-toggle="collapse" href="#sub-item-1">
                <em class="fa fa-navicon">&nbsp;</em> Obat <span data-toggle="collapse" href="#sub-item-1" class="icon pull-right"><em class="fa fa-plus"></em></span>
                </a>
                <ul class="children collapse" id="sub-item-1">
                    <li><a class="" href="<?php echo base_url().'index.php/admin/obat/add_obat'?>">
                        <span class="fa fa-arrow-right">&nbsp;</span> Tambah Obat
                    </a></li>
                    <li><a class="" href="#">
                        <span class="fa fa-arrow-right">&nbsp;</span> Tambah stok
                    </a></li>
                    <li><a class="" href="<?php echo base_url().'index.php/admin/obat/obat'?>">
                        <span class="fa fa-arrow-right">&nbsp;</span> Daftar Obat
                    </a></li>
                </ul>
            </li>

                    <li class="parent "><a data-toggle="collapse" href="#sub-item-2">
                <em class="fa fa-navicon">&nbsp;</em> Penjualan <span data-toggle="collapse" href="#sub-item-2" class="icon pull-right"><em class="fa fa-plus"></em></span>
                </a>
                <ul class="children collapse" id="sub-item-2">
                    <li><a class="" href="<?php echo base_url().'index.php/admin/obat/penjualan'?>">
                        <span class="fa fa-arrow-right">&nbsp;</span> Kasir
                    </a></li>
                    <li><a class="" href="#">
                        <span class="fa fa-arrow-right">&nbsp;</span> Lihat Penjualan
                    </a></li>
                    <li><a class="" href="#">
                        <span class="fa fa-arrow-right">&nbsp;</span> Grafik Penjualan
                    </a></li>
                </ul>
            </li>

                    <li class="parent "><a data-toggle="collapse" href="#sub-item-3">
                <em class="fa fa-navicon">&nbsp;</em> Supplier <span data-toggle="collapse" href="#sub-item-3" class="icon pull-right"><em class="fa fa-plus"></em></span>
                </a>
                <ul class="children collapse" id="sub-item-3">
                    <li><a class="" href="#">
                        <span class="fa fa-arrow-right">&nbsp;</span> Tambah Supplier
                    </a></li>
                    <li><a class="" href="<?php echo base_url().'index.php/admin/supplier/supplier'?>">
                        <span class="fa fa-arrow-right">&nbsp;</span> Daftar Supplier
                    </a></li>
                    
                </ul>
            </li>

            <li><a href="<?php echo base_url().'index.php/admin/home/logout'?>"><em class="fa fa-power-off">&nbsp;</em> Logout</a></li>
        </ul>

    </div><!--/.sidebar-->
        
    <div class="col-sm-9 col-sm-offset-3 col-lg-10 col-lg-offset-2 main">
        <div class="row">
            <ol class="breadcrumb">
                <li><a href="#">
                    <em class="fa fa-home"></em>
                </a></li>
                <li class="active">Dashboard</li>
            </ol>
        </div><!--/.row-->
        
        <div class="row">
            <div class="col-lg-12">
                <h1 class="page-header">Dashboard</h1>
            </div>
        </div><!--/.row-->
        
       <div class="panel panel-primary">
                    <div class="panel-heading">Tambah Obat
                                            <span class="pull-right clickable panel-toggle"><em class="fa fa-toggle-up"></em></span></div>
                    <div class="panel-body">
            <div class="col-md-12">
           <?php
             $cek_obat = $this->db->query("SELECT * from obat");
             

           $cekfsnkategori = $this->db->query("SELECT obat.nama,obat.id,obat.stok,obat.type,penjualan.kode,penjualan.qty,penjualan.tgl from obat join penjualan on obat.id = penjualan.kode where penjualan.tgl between '$lw' and '$td' ");

           foreach ($cekfsnkategori->result_array() as $i) {
            $nama_obat = $i['nama'];
            $stok_obt = $i['stok'];
            $id_obat = $i['id'];
            $id_penjualan = $i['kode'];
            $qty = $i['qty'];

               # code...
           }
           ?>
                <?php
                    $no=0;
                    foreach ($data2 as $i2) :
                    
                       //$id=$i['id_supplier'];
                        $id_obat_fsn[]=$i2->id;
                        //$namaobat[]=$i5->nama;
                        //$qtyajoin[]=$i5->jual;
                        $stokobat[]=$i2->stok;
                    ?>
                <?php endforeach;?>
<?php 
//$i=0;
//$hd[$i]=$stokobat;
$j=0;
$tgl_k = 13;
 $avs= 0;
 $crc=0;
for($i=0;$i<$jum_obat; $i++) {
//echo $id_obat_fsn[$i];
//echo "</br>";
    $rq[]=0;
     $hd[]=0;
    $tgl_k=13;
    $iq[]=0;
    
    # code...
for ($tgl_k; $tgl_k>=0; $tgl_k--) {
    # code...
     $tgl1  = date('Y-m-d',strtotime("-$tgl_k day"));


$cek_penjualan[$j] = $this->db->query("SELECT id_obat,sum(qty) as qty FROM penjualan where tgl = '$tgl1' and  id_obat = '$id_obat_fsn[$i]' ");
$cekj[$j] = $cek_penjualan[$j]->num_rows(); 
        foreach ($cek_penjualan[$j]->result_array() as $x) {
                    # code...
                //$query->result_array();
                    # code...
                    $id_obatj[$j] = $x['id_obat']; 
                      $q[$j] = $x['qty'];

                # code...
            
          }

          $cek_pembelian[$j] = $this->db->query("SELECT id_obat,sum(qty) as qty FROM pembelian where tgl = '$tgl1' and  id_obat = '$id_obat_fsn[$i]' ");
          $cekb[$j] = $cek_pembelian[$j]->num_rows();
        foreach ($cek_pembelian[$j]->result_array() as $x) {
                    # code...
                //$query->result_array();
                    # code...
                
                      $qp[$j] = $x['qty'];

                # code...
            
          }
    
          if($cekb[$j]==0){
            //echo "kosong </br>";
            $hd[$i]= $stokobat[$i]+$hd[$i];
                //echo $q[$j];
          }else{
            $hd[$i] = $stokobat[$i]+$qp[$j]+$hd[$i];
            $rq[$i] = $qp[$j]+$rq[$i];
            //$op[$i] = $rq[$i];
            //echo $op[$i];
            //echo $id_obatj[$j];

            //echo "</br>";
                   
    }

    if($cekj[$j]==0){

    }else{
        $hd[$i]= $hd[$i] - $q[$j];
        $iq[$i] = $q[$j]+$iq[$i];
        //echo $q[$j];
    }
  
            //echo $tgl1;
        $j++;
    //$tgl_k--;
    }

 
   //echo "</br>";
    //echo $hd[$i];
    //echo $rq[$i];
    $op[$i] = $stokobat[$i]+$rq[$i];
    //echo $op[$i];
    $as[$i] = $hd[$i] / $op[$i];
   $cr[$i] = $iq[$i ]/14;
    $crc = $crc + $cr[$i];
   $avs = $avs+$as[$i];
   //echo $id_obat_fsn[$i];
  //echo $as[$i];
   //echo $cr[$i];
 //  echo "</br>";
 
}
/*echo $as[0];
//asort($as);
for($a=0;$a<$jum_obat; $a++){
    echo $as[$a];
    print_r($as)
}*/
 // echo $avs;
 $cumavs = 0;

 //$fsn = "N";
for($i=0;$i<$jum_obat;$i++){

 for($b=$i;$b<$jum_obat;$b++){
  if($as[$b]>$as[$i]) {
   $tmp = $as[$b];
   $as[$b] = $as[$i];
   $as[$i] = $tmp; 
   $tmpid = $id_obat_fsn[$b];
   $id_obat_fsn[$b] = $id_obat_fsn[$i];
   $id_obat_fsn[$i] = $tmpid;
  }
 }
}
echo "
";
echo "Hasil Urutan data ASC 
</br>";
for($j=0;$j<$jum_obat;$j++){
   $avsc[] = 0;
   $fsn[] = "";
 echo $as[$j].'
';
$cumavs = $as[$j]+$cumavs;
//echo $cumavs;

$avsc[$j] = $cumavs/$avs*(100);
echo $avsc[$j];
echo ",";
if($avsc[$j]<=70){
    $fsn[$j] = "N";
}elseif ($avsc[$j]<=91) {
    $fsn[$j] = "S";
    # code...
}else {
    # code...
    $fsn[$j] = "F";
}
echo $fsn[$j];
echo ",";
echo $id_obat_fsn[$j];
//echo $id_obat_fsn[$a].'';
//echo $as[0];
echo "</br>";

$cekdata = $this->db->query("SELECT * from avgstay where id_obat = '$id_obat_fsn[$j]'");
foreach ($cekdata->result_array() as $m) {
            $id_obatcek = $m['id_obat'];
            $cumavgstaycek = $m['cumavgstay'];
            $clasificationcek = $m['clasification']; 
    # code...
}
if(empty($id_obatcek) and empty($cumavgstaycek) and empty($clasificationcek)){
    $insertavg = $this->db->query("INSERT INTO avgstay (cumavgstay,clasification,id_obat)values('$avsc[$j]','$fsn[$j]','$id_obat_fsn[$j]')");
}else{
    $updateavg = $this->db->query("UPDATE avgstay set cumavgstay = '$avsc[$j]',clasification = '$fsn[$j]',id_obat = '$id_obat_fsn[$j]' where id_obat = '$id_obat_fsn[$j]'");
}
}

echo "</br>";

 $cumcrc= 0;
for($i=0;$i<$jum_obat;$i++){
 for($b=$i;$b<$jum_obat;$b++){
  if($cr[$b]>$cr[$i]) {
   $tmp = $cr[$b];
   $cr[$b] = $cr[$i];
   $cr[$i] = $tmp; 
   $tmpid = $id_obat_fsn[$b];
   $id_obat_fsn[$b] = $id_obat_fsn[$i];
   $id_obat_fsn[$i] = $tmpid;

  }
 }
}
echo "
";
echo "Hasil Urutan data ASC 
";
for($k=0;$k<$jum_obat;$k++){
    $avcrc[]=0;
    $fsnrc[] = "";
/* echo $cr[$k].'
';*/
$cumcrc = $cr[$k]+$cumcrc;
$avcrc[$k] = $cumcrc / $crc*(100);
echo $avcrc[$k];
//echo ",";
if($avcrc[$k]<=70){
    $fsnrc[$k] ="F"; 

}else if($avcrc[$k]<=91){
    $fsnrc[$k]= "S";

}
else{
    $fsnrc[$k] = "N";
}
//echo $id_obat_fsn[$a].'';
//echo $as[0];
echo $fsnrc[$k];
echo ",";
echo $id_obat_fsn[$k];
echo "</br>";
$cekdata = $this->db->query("SELECT * from consumsition where id_obat = '$id_obat_fsn[$k]'");
foreach ($cekdata->result_array() as $m) {
            $id_obatcekcr = $m['id_obat'];
            $cumcr = $m['consumtionrt'];
            $clasificationcr = $m['clasification']; 
    # code...
}
if(empty($id_obatcekcr) and empty($cumcr) and empty($clasificationcr)){
    $insertcr = $this->db->query("INSERT INTO consumsition (consumtionrt,clasification,id_obat)values('$avcrc[$k]','$fsnrc[$k]','$id_obat_fsn[$k]')");
}else{
    $updatecr = $this->db->query("UPDATE consumsition set consumtionrt = '$avcrc[$k]',clasification = '$fsnrc[$k]',id_obat = '$id_obat_fsn[$k]' where id_obat = '$id_obat_fsn[$k]'");
}
}




echo "</br>";


for($i=0;$i<$jum_obat;$i++){
 for($b=$i;$b<$jum_obat;$b++){
  if($id_obat_fsn[$b]<$id_obat_fsn[$i]) {

   $tmp = $id_obat_fsn[$b];
   $id_obat_fsn[$b] = $id_obat_fsn[$i];
   $id_obat_fsn[$i] = $tmp; 

   $tmpavs = $avsc[$b];
   $avsc[$b] = $avsc[$i];
   $avsc[$i] = $tmpavs;

   $tmpfsnavs = $fsn[$b];
   $fsn[$b] = $fsn[$i];
   $fsn[$i] = $tmpfsnavs;

   $tmpcr = $avcrc[$b];
   $avcrc[$b] = $avcrc[$i];
   $avcrc[$i] = $tmpcr;

   $tmpfsncr = $fsnrc[$b];
   $fsnrc[$b] = $fsnrc[$i];
   $fsnrc[$i] = $tmpfsncr;

  }
 }
}
echo "
";
echo "Hasil Urutan data ASC 
";
echo "</br>";
$j=0;
for($a=0;$a<$jum_obat;$a++){


 echo $id_obat_fsn[$a].',
';
echo $avcrc[$a].',
';
echo $avsc[$j].',
';
echo $fsnrc[$a].',
';
echo $fsn[$j].',
';
echo "</br>";
$j++;
}
//echo $id_obat_fsn[$i];
//echo $q;
//echo $lw;

?>


<?php 






?>
        </div>
        </div>
        </div>
   
        
        <div class="row">
           
            <div class="col-sm-12">
                <p class="back-link">Lumino Theme by <a href="https://www.medialoot.com">Medialoot</a></p>
            </div>
        </div><!--/.row-->
    </div>  <!--/.main-->
    
    <script src="<?php echo base_url().'desain/lumino/js/jquery-1.11.1.min.js'?>"></script>
    <script src="<?php echo base_url().'desain/lumino/js/bootstrap.min.js'?>"></script>
    <script src="<?php echo base_url().'desain/lumino/js/chart.min.js'?>"></script>
    <script src="<?php echo base_url().'desain/lumino/js/chart-data.js'?>"></script>
    <script src="<?php echo base_url().'desain/lumino/js/easypiechart.js'?>"></script>
    <script src="<?php echo base_url().'desain/lumino/js/easypiechart-data.js'?>"></script>
    <script src="<?php echo base_url().'desain/lumino/js/bootstrap-datepicker.js'?>"></script>
    <script src="<?php echo base_url().'desain/lumino/js/custom.js'?>"></script>
    <script type="text/javascript" src="<?php echo base_url().'assets/plugins/toast/jquery.toast.min.js'?>"></script>

    <script type="text/javascript">
            var today = new Date();
            var dd = today.getDate();
            var mm = today.getMonth();
            var yyyy = today.getFullYear();
            if(dd<0){
                dd= '0'+dd
            }
            if(mm<0){
                mm='0'+mm
            }
            today = yyyy+'-'+mm+'-'+dd;


           // console.log(today);
        
            var i = 0;
            var j = 0;
            var c= 0;
            var hd = "";
            var count = <?php echo $jum_obat; ?>;
            var qtyb = <?php echo json_encode($qtyb);?>;
        var qtyj = <?php echo json_encode($qtyj);?>;
        var kode = <?php echo json_encode($qtyb);?>;
        var id_pembelian = <?php echo json_encode($id_pembelian);?>;
        var totalj = <?php echo json_encode($totalj);?>;
        var totalb = <?php echo json_encode($totalb);?>;
        var tglj = <?php echo json_encode($tglj);?>;
        var tglb = <?php echo json_encode($tglb);?>;
        var id_obatj = <?php echo json_encode($id_obatj);?>;
        var id_obatb = <?php echo json_encode($id_obatb);?>;
        console.log(count);
        //console.log(qtyb[0]);
 
        var td1 = <?php echo $td; ?>;
        var tl1 = new Date(<?php echo $lw; ?>);

        console.log(td1);

       


    
    </script>

</body>
</html>